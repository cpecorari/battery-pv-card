<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Battery PV System - Compact</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        max-width: 400px;
        width: 100%;
      }

      .controls {
        text-align: center;
        margin-bottom: 20px;
      }

      .controls button {
        background: #4a5568;
        color: white;
        border: none;
        padding: 8px 16px;
        margin: 5px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        transition: background 0.3s;
      }

      .controls button:hover {
        background: #2d3748;
      }

      /* Compact Card */
      .compact {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(2px);
        border-radius: 12px;
        padding: 12px 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        gap: 12px;
      }

      /* Gauges Section on Left */
      .gauges-section {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .battery-section,
      .solar-section,
      .house-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 70px;
      }

      /* New Battery Bar Styles */
      .battery-bar-wrapper {
        position: relative;
        width: 90px;
        height: 112px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .battery-bar-svg {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
      }

      .battery-bar-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
        pointer-events: none;
      }

      .battery-bar-center .gauge-percentage {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
        margin-bottom: 4px;
      }

      .battery-bar-center .gauge-value {
        font-size: 16px;
      }

      #battery-level-bar {
        transition: transform 0.6s ease;
      }

      #battery-power-border {
        filter: drop-shadow(0 0 3px currentColor) drop-shadow(0 0 6px currentColor);
      }

      .battery-section .gauge-wrapper {
        --glow-color: rgba(107, 114, 128, 0.3);
        --glow-color-mid: rgba(107, 114, 128, 0.2);
        --glow-bright: rgba(156, 163, 175, 0.4);
      }

      .battery-section .gauge-svg {
        background: none !important;
      }

      .battery-section .gauge-fill {
        filter: none !important;
      }

      .battery-section .gauge-bg {
        stroke: rgba(255, 255, 255, 0.15);
      }

      .solar-section .gauge-wrapper {
        --glow-color: rgba(251, 191, 36, 0.25);
        --glow-color-mid: rgba(251, 191, 36, 0.15);
        --glow-bright: rgba(254, 243, 199, 0.3);
      }

      .solar-section .gauge-svg {
        background: none !important;
      }

      .solar-section .gauge-fill {
        filter: none !important;
      }

      .house-section .gauge-wrapper {
        --glow-color: rgba(96, 165, 250, 0.25);
        --glow-color-mid: rgba(96, 165, 250, 0.15);
        --glow-bright: rgba(191, 219, 254, 0.3);
      }

      .house-section .gauge-svg {
        background: none !important;
      }

      .house-section .gauge-fill {
        filter: none !important;
      }

      /* Disable pseudo-element glows for all gauges */
      .gauge-wrapper::before,
      .gauge-wrapper::after {
        display: none !important;
      }

      .gauge-wrapper {
        position: relative;
        width: 70px;
        height: 70px;
        filter: contrast(1.15) brightness(1.2);
        isolation: isolate;
        background: transparent;
      }

      .house-section .gauge-wrapper {
        width: 90px;
        height: 90px;
      }

      .gauge-wrapper::before {
        content: '';
        position: absolute;
        inset: -8px;
        border-radius: 50%;
        background: radial-gradient(
          circle at center,
          var(--glow-color, rgba(96, 165, 250, 0.15)) 0%,
          var(--glow-color-mid, rgba(96, 165, 250, 0.08)) 40%,
          transparent 70%
        );
        z-index: 0;
        opacity: 0.8;
        pointer-events: none;
      }

      .gauge-wrapper::after {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 50%;
        background: radial-gradient(
          circle at center,
          var(--glow-bright, rgba(255, 255, 255, 0.2)) 0%,
          var(--glow-color, rgba(96, 165, 250, 0.15)) 30%,
          transparent 60%
        );
        z-index: 0;
        filter: blur(3px);
        opacity: 0.5;
        pointer-events: none;
      }

      .gauge-svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 1;
        overflow: visible;
      }

      .battery-section .gauge-svg {
        background: none !important;
      }

      .gauge-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.1);
        stroke-width: 8;
      }

      .gauge-fill {
        fill: none;
      }

      .gauge-glow {
        display: none;
      }

      .gauge-fill {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease, stroke 0.5s ease;
        filter: drop-shadow(0 0 2px currentColor) drop-shadow(0 0 4px currentColor) drop-shadow(0 0 8px currentColor);
      }

      #house-solar-gauge {
        stroke-width: 5;
      }

      #house-battery-gauge {
        stroke-width: 5;
      }

      .gauge-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 2;
      }

      .gauge-value {
        color: white;
        font-size: 18px;
        font-weight: 600;
        line-height: 1;
      }

      .gauge-unit {
        color: rgba(255, 255, 255, 0.6);
        font-size: 10px;
        margin-top: 2px;
      }

      .gauge-percentage {
        color: rgba(255, 255, 255, 0.5);
        font-size: 9px;
        margin-top: -4px;
      }

      .gauge-label {
        text-align: center;
        color: rgba(255, 255, 255, 0.6);
        font-size: 10px;
        margin-top: 2px;
        font-weight: 500;
        display: flex;
        flex-direction: row;
        gap: 2px;
      }

      .battery-section .gauge-label {
        display: none;
      }

      .solar-section {
        display: none;
      }

      .house-section .gauge-label {
        display: none;
      }

      .house-section .gauge-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
      }

      .house-section .solar-power-label {
        color: #fbbf24;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .house-section .gauge-value-wrapper {
        display: flex;
        align-items: baseline;
        gap: 3px;
      }

      .house-section .gauge-value {
        font-size: 20px;
      }

      .house-section .gauge-unit {
        font-size: 9px;
        margin-top: 0;
      }

      .battery-power {
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 11px;
        margin-top: 4px;
      }

      /* Right Section */
      .right {
        display: flex;
        flex-direction: column;
        margin-left: 24px;
        gap: 2px;
        flex: 1;
      }

      .card-name {
        font-weight: 600;
        font-size: 15px;
        color: white;
      }

      .info-row {
        display: flex;
        align-items: center;
        gap: 8px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
      }

      .info-item {
        display: grid;
        grid-template-columns: 18px 1fr;
        align-items: center;
        gap: 6px;
        width: 100%;
      }

      .icon {
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .icon svg {
        width: 100%;
        height: 100%;
      }

      .value {
        font-weight: 500;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="controls">
        <button onclick="setScenario('charging')">Charging</button>
        <button onclick="setScenario('discharging')">Discharging</button>
        <button onclick="setScenario('peak-solar')">Peak Solar</button>
        <button onclick="setScenario('night')">Night</button>
        <button onclick="setScenario('balanced')">Balanced</button>
      </div>

      <div class="compact">
        <!-- Gauges Section -->
        <div class="gauges-section">
          <!-- Battery Gauge - Vertical Bar -->
          <div class="battery-section">
            <div class="battery-bar-wrapper">
              <svg class="battery-bar-svg" viewBox="0 0 90 112" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <!-- Gradient for battery level (red at bottom → yellow → green at top) -->
                  <linearGradient id="battery-level-gradient" x1="0%" y1="100%" x2="0%" y2="0%">
                    <stop offset="0%" style="stop-color: #ef4444; stop-opacity: 1" />
                    <stop offset="30%" style="stop-color: #f59e0b; stop-opacity: 1" />
                    <stop offset="60%" style="stop-color: #eab308; stop-opacity: 1" />
                    <stop offset="100%" style="stop-color: #10b981; stop-opacity: 1" />
                  </linearGradient>
                  <!-- Mask for battery fill -->
                  <mask id="battery-fill-mask">
                    <rect x="30" y="18" width="30" height="78" fill="white" rx="3" />
                  </mask>
                </defs>

                <!-- Background bar -->
                <rect
                  x="30"
                  y="18"
                  width="30"
                  height="78"
                  fill="rgba(255,255,255,0.1)"
                  rx="3"
                  stroke="rgba(255,255,255,0.2)"
                  stroke-width="1"
                />

                <!-- Battery level fill with gradient -->
                <rect
                  id="battery-level-bar"
                  x="30"
                  y="18"
                  width="30"
                  height="78"
                  fill="url(#battery-level-gradient)"
                  mask="url(#battery-fill-mask)"
                  style="transform-origin: 45px 96px; transform: scaleY(0)"
                />

                <!-- Charging border (green, anti-clockwise from left of terminal) -->
                <rect
                  id="battery-charging-border"
                  x="24"
                  y="12"
                  width="42"
                  height="90"
                  fill="none"
                  rx="5"
                  stroke="#10b981"
                  stroke-width="3"
                  opacity="0"
                  style="
                    stroke-dasharray: 0 260;
                    stroke-dashoffset: -28;
                    transform: scaleX(-1);
                    transform-origin: 45px 56px;
                    transition: stroke-dasharray 0.5s ease, opacity 0.3s ease;
                  "
                />

                <!-- Discharging border (red, clockwise from right of terminal) -->
                <rect
                  id="battery-discharging-border"
                  x="24"
                  y="12"
                  width="42"
                  height="90"
                  fill="none"
                  rx="5"
                  stroke="#ef4444"
                  stroke-width="3"
                  opacity="0"
                  style="
                    stroke-dasharray: 0 260;
                    stroke-dashoffset: -28;
                    transition: stroke-dasharray 0.5s ease, opacity 0.3s ease;
                  "
                />

                <!-- Battery terminal on top -->
                <rect x="37" y="10" width="16" height="4" fill="rgba(255,255,255,0.3)" rx="1.5" />
              </svg>
              <div class="battery-bar-center">
                <div class="gauge-percentage" id="battery-percentage">50%</div>
                <div class="gauge-value" id="battery-display">0</div>
                <div class="gauge-unit">kW</div>
              </div>
            </div>
            <div class="gauge-label">
              <div>
                Battery
                <span class="gauge-percentage">50%</span>
              </div>
            </div>
          </div>

          <!-- Solar Gauge -->
          <div class="solar-section">
            <div class="gauge-wrapper">
              <svg class="gauge-svg" viewBox="0 0 100 100">
                <defs>
                  <linearGradient id="solar-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color: #6b7280; stop-opacity: 1" />
                    <stop offset="10%" style="stop-color: #fef3c7; stop-opacity: 1" />
                    <stop offset="25%" style="stop-color: #fbbf24; stop-opacity: 1" />
                    <stop offset="50%" style="stop-color: #f59e0b; stop-opacity: 1" />
                    <stop offset="75%" style="stop-color: #f87171; stop-opacity: 1" />
                    <stop offset="100%" style="stop-color: #dc2626; stop-opacity: 1" />
                  </linearGradient>
                </defs>
                <circle class="gauge-bg" cx="50" cy="50" r="47"></circle>
                <circle id="solar-gauge" class="gauge-fill" cx="50" cy="50" r="47"></circle>
              </svg>
              <div class="gauge-center">
                <div class="gauge-value" id="solar-display">0</div>
                <div class="gauge-unit">kW</div>
              </div>
            </div>
            <div class="gauge-label">Solar</div>
          </div>

          <!-- House Load Gauge -->
          <div class="house-section">
            <div class="gauge-wrapper">
              <svg class="gauge-svg" viewBox="0 0 100 100">
                <defs>
                  <linearGradient id="house-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color: #10b981; stop-opacity: 1" />
                    <stop offset="50%" style="stop-color: #fbbf24; stop-opacity: 1" />
                    <stop offset="100%" style="stop-color: #dc2626; stop-opacity: 1" />
                  </linearGradient>
                </defs>
                <!-- Background circles -->
                <circle class="gauge-bg" cx="50" cy="50" r="47"></circle>
                <circle class="gauge-bg" cx="50" cy="50" r="39"></circle>
                <!-- Outer circle: total house load (green to red gradient) -->
                <circle
                  id="house-total-gauge"
                  class="gauge-fill"
                  cx="50"
                  cy="50"
                  r="47"
                  style="transition: stroke-dasharray 0.6s ease, stroke-dashoffset 0.6s ease"
                ></circle>
                <!-- Inner circle: solar contribution -->
                <circle
                  id="house-solar-gauge"
                  class="gauge-fill"
                  cx="50"
                  cy="50"
                  r="39"
                  style="
                    stroke: #fbbf24;
                    transition: stroke-dasharray 0.6s ease, stroke-dashoffset 0.6s ease, visibility 0s 0.6s;
                  "
                ></circle>
                <!-- Inner circle: battery contribution (follows solar) -->
                <circle
                  id="house-battery-gauge"
                  class="gauge-fill"
                  cx="50"
                  cy="50"
                  r="39"
                  style="
                    stroke: #10b981;
                    transition: stroke-dasharray 0.6s ease, stroke-dashoffset 0.6s ease, visibility 0s 0.6s;
                  "
                ></circle>
              </svg>
              <div class="gauge-center">
                <div class="solar-power-label" id="solar-power-display">0 W</div>
                <div class="gauge-value-wrapper">
                  <div class="gauge-value" id="house-display">0</div>
                  <div class="gauge-unit">kW</div>
                </div>
              </div>
            </div>
            <div class="gauge-label">House</div>
          </div>
        </div>

        <!-- Right Section - Vertical Column -->
        <div class="right">
          <!-- Solar Row -->
          <div class="info-row">
            <div class="info-item">
              <div class="icon" style="color: #fbbf24">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,6.65C6.9,7.16 6.36,7.78 5.94,8.5C5.5,9.24 5.25,10 5.11,10.79L3.34,7M3.36,17L5.12,13.23C5.26,14 5.53,14.78 5.95,15.5C6.37,16.24 6.91,16.86 7.5,17.37L3.36,17M20.65,7L18.88,10.79C18.74,10 18.47,9.23 18.05,8.5C17.63,7.78 17.1,7.15 16.5,6.64L20.65,7M20.64,17L16.5,17.36C17.09,16.85 17.62,16.22 18.04,15.5C18.46,14.77 18.73,14 18.87,13.21L20.64,17M12,22L9.59,18.56C10.33,18.83 11.14,19 12,19C12.82,19 13.63,18.83 14.37,18.56L12,22Z"
                  />
                </svg>
              </div>
              <span class="value" id="solar-value">0 W</span>
            </div>
          </div>

          <!-- Battery Row -->
          <div class="info-row">
            <div class="info-item">
              <div class="icon" style="color: #60a5fa">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M16,18H8V6H16M16.67,4H15V2H9V4H7.33A1.33,1.33 0 0,0 6,5.33V20.67C6,21.4 6.6,22 7.33,22H16.67A1.33,1.33 0 0,0 18,20.67V5.33C18,4.6 17.4,4 16.67,4Z"
                  />
                </svg>
              </div>
              <span class="value" id="battery-power">0 W</span>
            </div>
          </div>

          <!-- Card Name -->
          <div class="card-name"></div>

          <!-- House Row -->
          <div class="info-row">
            <div class="info-item">
              <div class="icon" style="color: #10b981">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M5 20V12H2L12 3L22 12H19V20H5M12 5.69L7 10.19V18H17V10.19L12 5.69M11.5 18V14H9L12.5 7V11H15L11.5 18Z"
                  />
                </svg>
              </div>
              <span class="value" id="house-value">0 W</span>
            </div>
          </div>

          <!-- Grid Row -->
          <div class="info-row">
            <div class="info-item">
              <div class="icon" style="color: #ef4444">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M8.28,5.45L6.5,4.55L7.76,2H16.23L17.5,4.55L15.72,5.44L15,4H9L8.28,5.45M18.62,8H14.09L13.3,5H10.7L9.91,8H5.38L4.1,10.55L5.89,11.44L6.62,10H17.38L18.1,11.45L19.89,10.56L18.62,8M17.77,22H15.7L15.46,21.1L12,15.9L8.53,21.1L8.3,22H6.23L9.12,11H11.19L10.83,12.35L12,14.1L13.16,12.35L12.81,11H14.88L17.77,22M11.4,15L10.5,13.65L9.32,18.13L11.4,15M14.68,18.12L13.5,13.64L12.6,15L14.68,18.12Z"
                  />
                </svg>
              </div>
              <span class="value" id="grid-value">0 W</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Calculate circle circumference - for solar and house gauges
      const radius = 47;
      const circumference = 2 * Math.PI * radius;
      const innerRadius = 39; // For house gauge inner circle
      const innerCircumference = 2 * Math.PI * innerRadius;

      // Initialize solar gauge
      const solarGauge = document.getElementById('solar-gauge');
      solarGauge.style.strokeDasharray = circumference;
      solarGauge.style.strokeDashoffset = circumference;

      // Initialize glow CSS variables with default values
      const solarWrapper = document.querySelector('.solar-section .gauge-wrapper');
      const houseWrapper = document.querySelector('.house-section .gauge-wrapper');

      if (solarWrapper) {
        solarWrapper.style.setProperty('--glow-color', 'rgba(107, 114, 128, 0.25)');
        solarWrapper.style.setProperty('--glow-color-mid', 'rgba(107, 114, 128, 0.15)');
        solarWrapper.style.setProperty('--glow-bright', 'rgba(156, 163, 175, 0.3)');
      }
      if (houseWrapper) {
        houseWrapper.style.setProperty('--glow-color', 'rgba(96, 165, 250, 0.25)');
        houseWrapper.style.setProperty('--glow-color-mid', 'rgba(96, 165, 250, 0.15)');
        houseWrapper.style.setProperty('--glow-bright', 'rgba(255, 255, 255, 0.3)');
      }

      function updateBatteryGauge(soc, power) {
        // Update vertical bar fill based on SOC
        const batteryLevelBar = document.getElementById('battery-level-bar');
        const chargingBorder = document.getElementById('battery-charging-border');
        const dischargingBorder = document.getElementById('battery-discharging-border');

        // Scale the battery level bar from bottom to top
        const fillScale = soc / 100;
        batteryLevelBar.style.transform = `scaleY(${fillScale})`;

        // Calculate power border animation
        const maxBatteryPower = 3000;
        const powerPercent = Math.min(Math.abs(power) / maxBatteryPower, 1);
        const borderCircumference = 240;
        const powerArcLength = powerPercent * borderCircumference;

        if (power > 50) {
          // Charging - green border, anti-clockwise from left of terminal
          chargingBorder.style.opacity = 0.9;
          chargingBorder.style.strokeDasharray = `${powerArcLength} ${borderCircumference}`;
          dischargingBorder.style.opacity = 0;
        } else if (power < -50) {
          // Discharging - red border, clockwise from right of terminal
          dischargingBorder.style.opacity = 0.9;
          dischargingBorder.style.strokeDasharray = `${powerArcLength} ${borderCircumference}`;
          chargingBorder.style.opacity = 0;
        } else {
          // Idle - no border
          chargingBorder.style.opacity = 0;
          dischargingBorder.style.opacity = 0;
        }

        // Update values
        document.getElementById('battery-display').textContent = (Math.abs(power) / 1000).toFixed(1);
        document.getElementById('battery-percentage').textContent = soc + '%';

        // Update battery power in the info section
        const powerText = document.getElementById('battery-power');
        if (powerText) {
          powerText.textContent = (power > 0 ? '+' : '') + power + ' W';
        }
      }

      function updateSolarGauge(power) {
        // Update solar power display on house gauge
        const solarPowerDisplay = document.getElementById('solar-power-display');
        if (solarPowerDisplay) {
          if (power >= 1000) {
            solarPowerDisplay.textContent = (power / 1000).toFixed(1) + ' kW';
          } else {
            solarPowerDisplay.textContent = power + ' W';
          }
        }
        document.getElementById('solar-value').textContent = power + ' W';
      }

      function updateHouseGauge(houseLoad, solarPower, batteryContribution, gridContribution) {
        const totalGauge = document.getElementById('house-total-gauge');
        const solarGauge = document.getElementById('house-solar-gauge');
        const batteryGauge = document.getElementById('house-battery-gauge');
        const maxHouseLoad = 6000;

        // Outer circle: total house load with green-to-red gradient
        const totalPercentage = Math.min((houseLoad / maxHouseLoad) * 100, 100);
        const totalArcLength = (totalPercentage / 100) * circumference;
        totalGauge.style.strokeDasharray = `${totalArcLength} ${circumference}`;
        totalGauge.style.strokeDashoffset = 0;
        totalGauge.style.stroke = 'url(#house-gradient)';

        // Inner circle: show total solar power (can exceed house load)
        const solarPercentage = (solarPower / maxHouseLoad) * 100;
        const batteryPercentage = (batteryContribution / maxHouseLoad) * 100;

        // Convert percentages to arc lengths for inner circle
        const solarArcLength = (solarPercentage / 100) * innerCircumference;
        const batteryArcLength = (batteryPercentage / 100) * innerCircumference;

        // Solar segment (starts at 0)
        solarGauge.style.strokeDasharray = `${solarArcLength} ${innerCircumference}`;
        solarGauge.style.strokeDashoffset = 0;
        solarGauge.style.visibility = solarPower > 0 ? 'visible' : 'hidden';

        // Battery segment (follows solar)
        batteryGauge.style.strokeDasharray = `${batteryArcLength} ${innerCircumference}`;
        batteryGauge.style.strokeDashoffset = -solarArcLength;
        batteryGauge.style.visibility = batteryContribution > 0 ? 'visible' : 'hidden';

        // Update house display with inline unit
        const houseDisplay = document.getElementById('house-display');
        if (houseLoad >= 1000) {
          houseDisplay.textContent = (houseLoad / 1000).toFixed(1);
          document.querySelector('.house-section .gauge-unit').textContent = 'kW';
        } else {
          houseDisplay.textContent = houseLoad;
          document.querySelector('.house-section .gauge-unit').textContent = 'W';
        }
        document.getElementById('house-value').textContent = houseLoad + ' W';
      }

      function updateCompactInfo(data) {
        // Grid calculation
        let gridPower = data.houseLoad - data.solarPower;
        if (data.batteryPower < 0) {
          gridPower += data.batteryPower;
        }
        gridPower = Math.max(0, gridPower);
        document.getElementById('grid-value').textContent = Math.round(gridPower) + ' W';
      }

      function updateSystem(data) {
        updateBatteryGauge(data.batterySOC, data.batteryPower);
        updateSolarGauge(data.solarPower);

        // Calculate house load contributions
        let solarToHouse = 0;
        let batteryToHouse = 0;
        let gridToHouse = 0;

        if (data.solarPower > 0) {
          solarToHouse = Math.min(data.solarPower, data.houseLoad);
        }

        const remainingAfterSolar = data.houseLoad - solarToHouse;
        if (remainingAfterSolar > 0 && data.batteryPower < 0) {
          batteryToHouse = Math.min(Math.abs(data.batteryPower), remainingAfterSolar);
        }

        const remainingAfterBattery = remainingAfterSolar - batteryToHouse;
        if (remainingAfterBattery > 0) {
          gridToHouse = remainingAfterBattery;
        }

        // Pass total solar power instead of just contribution to house
        updateHouseGauge(data.houseLoad, data.solarPower, batteryToHouse, gridToHouse);
        updateCompactInfo(data);
      }

      // Scenarios
      const scenarios = {
        charging: {
          batterySOC: 65,
          batteryPower: 1200,
          solarPower: 2800,
          houseLoad: 800,
        },
        discharging: {
          batterySOC: 45,
          batteryPower: -850,
          solarPower: 0,
          houseLoad: 1500,
        },
        'peak-solar': {
          batterySOC: 88,
          batteryPower: 2200,
          solarPower: 4200,
          houseLoad: 650,
        },
        night: {
          batterySOC: 30,
          batteryPower: -600,
          solarPower: 0,
          houseLoad: 1200,
        },
        balanced: {
          batterySOC: 75,
          batteryPower: 0,
          solarPower: 1200,
          houseLoad: 1200,
        },
      };

      function setScenario(name) {
        const data = scenarios[name];
        if (data) {
          updateSystem(data);
        }
      }

      // Initialize with balanced scenario
      setScenario('balanced');
    </script>
  </body>
</html>
